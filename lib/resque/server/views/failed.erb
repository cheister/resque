<% @subtabs = resque.queues %>

<% if queue = params[:id] %>

  <% start = params[:start].to_i %>
  <% failed = Resque::Failure.all(queue, start, 20) %>
  <% index = 0 %>

  <h1>Failed Jobs for <span class='hl'><%= queue %></span></h1>
  <%unless failed.empty?%>
  <form method="POST" action="<%=u "failed/#{queue}/clear"%>" class='clear-failed'>
    <input type='submit' name='' value='Clear Failed Jobs' />
  </form>
  <%end%>

  <p class='sub'>Showing <%=start%> to <%= start + 20 %> of <b><%= size = Resque::Failure.count(queue) %></b> jobs</p>

  <ul class='failed'>
    <%for job in failed%>
      <% index += 1 %>
      <li>
        <dl>
          <dt>Worker</dt>
          <dd>
            <a href="<%= url(:workers, job['worker']) %>"><%= job['worker'].split(':')[0...2].join(':') %></a> on <b class='queue-tag'><%= job['queue'] %></b > at <b><span class="time"><%= job['failed_at'] %></span></b>
            <div class='retry'>
              <% if job['retried_at'] %>
                Retried <b><span class="time"><%= job['retried_at'] %></span></b>
              <% else %>
                <a href="<%= u "failed/#{queue}/requeue/#{start + index - 1}" %>" rel="retry">Retry</a>
              <% end %>
            </div>
          </dd>
          <dt>Class</dt>
          <dd><code><%= job['payload'] ? job['payload']['class'] : 'nil' %></code></dd>
          <dt>Arguments</dt>
          <dd><pre><%=h job['payload'] ? show_args(job['payload']['args']) : 'nil' %></pre></dd>
          <dt>Exception</td>
          <dd><code><%= job['exception'] %></code></dd>
          <dt>Error</dt>
          <dd class='error'>
            <% if job['backtrace'] %>
              <a href="#" class="backtrace"><%= h(job['error']) %></a>
              <pre style='display:none'><%=h job['backtrace'].join("\n") %></pre>
            <% else %>
              <%=h job['error'] %>
            <% end %>
          </dd>
        </dl>
        <div class='r'>
        </div>
      </li>
    <%end%>
  </ul>

  <%= partial :next_more, :start => start, :size => size %>

<% else %>

  <h1 class='wi'>Failed Jobs</h1>
  <p class='intro'>The list below contains all the registered queues with the number of failures for the queue. Select a queue from above to view all failed jobs for the queue.</p>
  <table class='queues'>
    <tr>
      <th>Name</th>
      <th>Failed</th>
    </tr>
    <% for queue in resque.queues.sort_by { |q| q.to_s } %>
    <tr>
      <td class='queue'><a class="queue" href="<%= url "failed/#{queue}" %>"><%= queue %></a></td>
      <td class='size failure'><%= Resque::Failure.count(queue) %></td>
    </tr>
    <% end %>
  </table>

<% end %>